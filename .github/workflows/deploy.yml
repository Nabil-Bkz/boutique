name: Deploy to Server

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      server_host:
        description: 'Server IP address'
        required: true
        default: '35.180.255.192'
      server_user:
        description: 'SSH user'
        required: true
        default: 'admin'

jobs:
  # Run CI tests before deploying
  test-backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      - name: Install dependencies
        run: uv sync --extra dev
      - name: Check formatting
        run: uv run ruff format --check .
      - name: Run linter
        run: uv run ruff check .
      - name: Run tests
        run: |
          cd core
          uv run python manage.py migrate
          uv run python manage.py test

  test-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Run linter
        run: npm run lint
      - name: Run tests
        run: npm test -- --run

  deploy:
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        continue-on-error: false

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå Error: SSH_PRIVATE_KEY secret is not set"
            echo "Please add it at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_HOST }}" ] && [ -z "${{ github.event.inputs.server_host }}" ]; then
            echo "‚ùå Error: SERVER_HOST secret is not set and no input provided"
            echo "Please add it at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          echo "‚úÖ Secrets validated"

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST || github.event.inputs.server_host }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST || github.event.inputs.server_host }}
          SERVER_USER: ${{ secrets.SERVER_USER || github.event.inputs.server_user }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/home/admin/boutique' }}
        run: |
          echo "üöÄ Starting deployment to $SERVER_USER@$SERVER_HOST"
          
          # Create deployment directory if it doesn't exist
          ssh $SERVER_USER@$SERVER_HOST "mkdir -p $DEPLOY_PATH"
          
          # Copy files to server
          echo "üì¶ Copying files to server..."
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.pytest_cache' \
            --exclude 'db.sqlite3' \
            ./ $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/
          
          # Deploy on server
          echo "üê≥ Deploying with Docker Compose..."
          ssh $SERVER_USER@$SERVER_HOST << EOF
            set -e
            cd $DEPLOY_PATH
            
            # Ensure Docker and Docker Compose are installed
            if ! command -v docker &> /dev/null; then
              echo "‚ùå Docker is not installed on the server"
              exit 1
            fi
            
            # Set environment variables for deployment
            export VITE_API_URL=http://$SERVER_HOST:8000
            export ALLOWED_HOSTS=$SERVER_HOST,localhost,127.0.0.1
            
            # Pull latest images and restart services with build args
            docker compose pull || docker-compose pull || true
            VITE_API_URL=http://$SERVER_HOST:8000 ALLOWED_HOSTS=$SERVER_HOST,localhost,127.0.0.1 docker compose up -d --build || VITE_API_URL=http://$SERVER_HOST:8000 ALLOWED_HOSTS=$SERVER_HOST,localhost,127.0.0.1 docker-compose up -d --build
            
            # Show running containers
            echo "‚úÖ Deployment complete! Running containers:"
            docker ps
            
            # Show logs
            echo "üìã Recent logs:"
            docker compose logs --tail=50 || docker-compose logs --tail=50
          EOF
          
          echo "‚úÖ Deployment successful!"

      - name: Health check
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST || github.event.inputs.server_host }}
        run: |
          echo "üè• Running health checks..."
          sleep 10
          
          # Check backend
          if curl -f http://$SERVER_HOST:8000/api/products/; then
            echo "‚úÖ Backend is healthy"
          else
            echo "‚ö†Ô∏è Backend health check failed"
          fi
          
          # Check frontend
          if curl -f http://$SERVER_HOST/; then
            echo "‚úÖ Frontend is healthy"
          else
            echo "‚ö†Ô∏è Frontend health check failed"
          fi

